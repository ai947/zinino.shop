<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفع منتج جديد</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body dir="rtl">
    <div class="container mt-5">
        <h2>رفع منتج جديد</h2>
        <form id="productForm">
            <div class="form-group">
                <label for="productName">اسم المنتج</label>
                <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="form-group">
                <label for="productPrice">السعر</label>
                <input type="number" class="form-control" id="productPrice" required>
            </div>
            <div class="form-group">
                <label for="productDescription">الوصف</label>
                <textarea class="form-control" id="productDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="productInfo">معلومات إضافية حول المنتج</label>
                <textarea class="form-control" id="productInfo"></textarea>
            </div>
            <div class="form-group">
                <label for="productImage">رفع صورة المنتج الأساسية</label>
                <input type="file" class="form-control" id="productImage" accept="image/*" required>
            </div>
            <div class="form-group">
                <label for="additionalImages">رفع صور إضافية (يمكنك اختيار أكثر من صورة)</label>
                <input type="file" class="form-control" id="additionalImages" accept="image/*" multiple required>
            </div>
            <div class="form-group">
                <label for="productVideos">رفع فيديوهات المنتج (يمكنك اختيار أكثر من فيديو)</label>
                <input type="file" class="form-control" id="productVideos" accept="video/*" multiple>
            </div>

            <button type="submit" class="btn btn-primary">رفع المنتج</button>
        </form>
    </div>

    <!-- نافذة منبثقة لتفاصيل المنتج -->
    <div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">تفاصيل المنتج</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="modalProductImage" src="" class="img-fluid" alt="Product Image">
                    <h5 id="modalProductName"></h5>
                    <p id="modalProductPrice"></p>
                    <p id="modalProductDescription"></p>
                    <p id="modalProductInfo"></p> <!-- معلومات إضافية -->
                    <div id="additionalImagesContainer" class="mb-3"></div> <!-- حاوية الصور الإضافية -->
                    <div id="additionalVideosContainer" class="mb-3"></div> <!-- حاوية الفيديوهات الإضافية -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('productForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productDescription = document.getElementById('productDescription').value;
            const productInfo = document.getElementById('productInfo').value; // معلومات إضافية
            const productImageFile = document.getElementById('productImage').files[0];
            const additionalImagesFiles = document.getElementById('additionalImages').files;
            const productVideosFiles = document.getElementById('productVideos').files; // الفيديوهات

            let products = JSON.parse(localStorage.getItem('products')) || [];
            const images = [];
            const videos = [];

            // تحقق مما إذا كان المنتج موجودًا بالفعل
            const isDuplicate = products.some(product => product.name === productName);
            if (isDuplicate) {
                alert('هذا المنتج موجود بالفعل!');
                return; // الخروج إذا كان المنتج مكررًا
            }

            // قراءة الصورة الأساسية
            if (productImageFile) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const mainImage = event.target.result;
                    images.push(mainImage); // إضافة الصورة الأساسية إلى المصفوفة

                    // قراءة كل صورة إضافية وإضافتها إلى مصفوفة الصور
                    const additionalImages = [];
                    let filesProcessed = 0; // عدد الملفات المعالجة

                    for (let i = 0; i < additionalImagesFiles.length; i++) {
                        const additionalImageFile = additionalImagesFiles[i];
                        const additionalImageReader = new FileReader();

                        additionalImageReader.onload = function (event) {
                            additionalImages.push(event.target.result);
                            filesProcessed++; // زيادة عدد الملفات المعالجة

                            // إذا كانت جميع الصور الإضافية قد تم تحميلها
                            if (filesProcessed === additionalImagesFiles.length) {
                                // قراءة كل فيديو وإضافته إلى مصفوفة الفيديوهات
                                let videoFilesProcessed = 0; // عدد ملفات الفيديو المعالجة
                                for (let j = 0; j < productVideosFiles.length; j++) {
                                    const videoFile = productVideosFiles[j];
                                    const videoReader = new FileReader();
                                    videoReader.onload = function (event) {
                                        videos.push(event.target.result); // إضافة الفيديو إلى المصفوفة
                                        videoFilesProcessed++; // زيادة عدد ملفات الفيديو المعالجة

                                        // إذا كانت جميع الفيديوهات قد تم تحميلها
                                        if (videoFilesProcessed === productVideosFiles.length) {
                                            // تخزين الصور والفيديوهات مع البيانات
                                            products.push({
                                                name: productName,
                                                price: productPrice,
                                                description: productDescription,
                                                info: productInfo, // تخزين المعلومات الإضافية
                                                images: [mainImage, ...additionalImages], // تخزين الصورة الأساسية مع الصور الإضافية
                                                videos: videos // تخزين الفيديوهات
                                            });
                                            localStorage.setItem('products', JSON.stringify(products));
                                            alert('تم رفع المنتج بنجاح!');
                                            document.getElementById('productForm').reset();
                                        }
                                    };
                                    videoReader.readAsDataURL(videoFile); // قراءة الفيديو
                                }

                                // إذا لم يكن هناك فيديوهات
                                if (productVideosFiles.length === 0) {
                                    products.push({
                                        name: productName,
                                        price: productPrice,
                                        description: productDescription,
                                        info: productInfo, // تخزين المعلومات الإضافية
                                        images: [mainImage, ...additionalImages], // تخزين الصورة الأساسية مع الصور الإضافية
                                        videos: [] // لا توجد فيديوهات
                                    });
                                    localStorage.setItem('products', JSON.stringify(products));
                                    alert('تم رفع المنتج بنجاح!');
                                    document.getElementById('productForm').reset();
                                }
                            }
                        };
                        additionalImageReader.readAsDataURL(additionalImageFile); // قراءة الصورة الإضافية
                    }

                    // إضافة الصور الإضافية إذا لم يكن هناك صور إضافية
                    if (additionalImagesFiles.length === 0) {
                        // قراءة كل فيديو وإضافته إلى مصفوفة الفيديوهات
                        let videoFilesProcessed = 0; // عدد ملفات الفيديو المعالجة
                        for (let j = 0; j < productVideosFiles.length; j++) {
                            const videoFile = productVideosFiles[j];
                            const videoReader = new FileReader();
                            videoReader.onload = function (event) {
                                videos.push(event.target.result); // إضافة الفيديو إلى المصفوفة
                                videoFilesProcessed++; // زيادة عدد ملفات الفيديو المعالجة

                                // إذا كانت جميع الفيديوهات قد تم تحميلها
                                if (videoFilesProcessed === productVideosFiles.length) {
                                    products.push({
                                        name: productName,
                                        price: productPrice,
                                        description: productDescription,
                                        info: productInfo, // تخزين المعلومات الإضافية
                                        images: [mainImage], // فقط الصورة الأساسية
                                        videos: videos // تخزين الفيديوهات
                                    });
                                    localStorage.setItem('products', JSON.stringify(products));
                                    alert('تم رفع المنتج بنجاح!');
                                    document.getElementById('productForm').reset();
                                }
                            };
                            videoReader.readAsDataURL(videoFile); // قراءة الفيديو
                        }

                        // إذا لم يكن هناك فيديوهات
                        if (productVideosFiles.length === 0) {
                            products.push({
                                name: productName,
                                price: productPrice,
                                description: productDescription,
                                info: productInfo, // تخزين المعلومات الإضافية
                                images: [mainImage], // فقط الصورة الأساسية
                                videos: [] // لا توجد فيديوهات
                            });
                            localStorage.setItem('products', JSON.stringify(products));
                            alert('تم رفع المنتج بنجاح!');
                            document.getElementById('productForm').reset();
                        }
                    }
                };
                reader.readAsDataURL(productImageFile); // قراءة الصورة الأساسية
            }
        });

        function showProductDetails(name, price, description, info, images, videos) {
            document.getElementById('modalProductName').innerText = name;
            document.getElementById('modalProductPrice').innerText = 'السعر: ' + price + ' DH';
            document.getElementById('modalProductDescription').innerText = description;
            document.getElementById('modalProductInfo').innerText = 'معلومات إضافية: ' + info; // عرض المعلومات الإضافية

            const modalProductImage = document.getElementById('modalProductImage');
            modalProductImage.src = images[0]; // عرض الصورة الأساسية

            const additionalImagesContainer = document.getElementById('additionalImagesContainer');
            additionalImagesContainer.innerHTML = ''; // تنظيف المحتوى السابق

            // إضافة الصور الإضافية
            images.slice(1).forEach(img => { // بدءًا من الصورة الثانية
                const imgElement = document.createElement('img');
                imgElement.src = img;
                imgElement.className = 'img-fluid mb-2'; // إضافة مساحة أسفل الصورة
                additionalImagesContainer.appendChild(imgElement);
            });

            const additionalVideosContainer = document.getElementById('additionalVideosContainer');
            additionalVideosContainer.innerHTML = ''; // تنظيف المحتوى السابق

            // إضافة الفيديوهات
            videos.forEach(video => {
                const videoElement = document.createElement('video');
                videoElement.src = video;
                videoElement.controls = true; // إضافة عناصر التحكم
                videoElement.className = 'w-100 mb-2'; // عرض الفيديو بشكل مناسب
                additionalVideosContainer.appendChild(videoElement);
            });

            $('#productModal').modal('show');
        }

        // أضف هذه الدالة في نهاية ملف JavaScript
        function displayProducts() {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const productList = document.getElementById('productList');

            // تنظيف القائمة السابقة
            productList.innerHTML = '';

            products.forEach((product, index) => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <h5>${product.name}</h5>
                    <p>${product.price} DH</p>
                    <button class="btn btn-info" onclick="showProductDetails('${product.name}', '${product.price}', '${product.description}', '${product.info}', ${JSON.stringify(product.images)}, ${JSON.stringify(product.videos)})">عرض التفاصيل</button>
                `;
                productList.appendChild(productItem);
            });
        }

        // استدعاء دالة عرض المنتجات بعد رفع المنتج
        document.getElementById('productForm').addEventListener('submit', function (e) {
            e.preventDefault();
            // ...الكود السابق هنا...

            // بعد رفع المنتج بنجاح، عرض المنتجات
            displayProducts();
        });

    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>

</html>
