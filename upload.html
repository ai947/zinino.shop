<!DOCTYPE html> 
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفع منتج جديد</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body dir="rtl">
    <div class="container mt-5">
        <h2>رفع منتج جديد</h2>
        <form id="productForm">
            <div class="form-group">
                <label for="productName">اسم المنتج</label>
                <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="form-group">
                <label for="productPrice">السعر</label>
                <input type="number" class="form-control" id="productPrice" required>
            </div>
            <div class="form-group">
                <label for="productDescription">الوصف</label>
                <textarea class="form-control" id="productDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="productInfo">معلومات إضافية حول المنتج</label>
                <textarea class="form-control" id="productInfo"></textarea>
            </div>
            <div class="form-group">
                <label for="productImage">رفع صورة المنتج الأساسية (اختياري)</label>
                <input type="file" class="form-control" id="productImage" accept="image/*">
            </div>
            <div class="form-group">
                <label for="additionalImages">رفع صور إضافية (اختياري، يمكنك اختيار أكثر من صورة)</label>
                <input type="file" class="form-control" id="additionalImages" accept="image/*" multiple>
            </div>
            <div class="form-group">
                <label for="productVideos">رفع فيديوهات المنتج (اختياري، يمكنك اختيار أكثر من فيديو)</label>
                <input type="file" class="form-control" id="productVideos" accept="video/*" multiple>
            </div>

            <button type="submit" class="btn btn-primary">رفع المنتج</button>
        </form>

        <div id="productList" class="mt-4"></div>
    </div>

    <div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">تفاصيل المنتج</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="modalProductImage" src="" class="img-fluid" alt="Product Image">
                    <h5 id="modalProductName"></h5>
                    <p id="modalProductPrice"></p>
                    <p id="modalProductDescription"></p>
                    <p id="modalProductInfo"></p>
                    <div id="additionalImagesContainer" class="mb-3"></div>
                    <div id="additionalVideosContainer" class="mb-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let currentEditingIndex = -1; // متغير لتتبع المنتج الجاري تعديله

        document.getElementById('productForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productDescription = document.getElementById('productDescription').value;
            const productInfo = document.getElementById('productInfo').value;
            const productImageFile = document.getElementById('productImage').files[0];
            const additionalImagesFiles = document.getElementById('additionalImages').files;
            const productVideosFiles = document.getElementById('productVideos').files;

            const images = [];
            const videos = [];

            if (productImageFile) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    images.push(event.target.result);
                    readAdditionalImages(additionalImagesFiles, images, productName, productPrice, productDescription, productInfo, videos);
                };
                reader.readAsDataURL(productImageFile);
            } else {
                readAdditionalImages(additionalImagesFiles, images, productName, productPrice, productDescription, productInfo, videos);
            }
        });

        function readAdditionalImages(additionalImagesFiles, images, productName, productPrice, productDescription, productInfo, videos) {
            const additionalImages = [];
            let filesProcessed = 0;

            for (let i = 0; i < additionalImagesFiles.length; i++) {
                const additionalImageFile = additionalImagesFiles[i];
                const additionalImageReader = new FileReader();

                additionalImageReader.onload = function (event) {
                    additionalImages.push(event.target.result);
                    filesProcessed++;

                    if (filesProcessed === additionalImagesFiles.length) {
                        readProductVideos(videos, productName, productPrice, productDescription, productInfo, images.concat(additionalImages));
                    }
                };
                additionalImageReader.readAsDataURL(additionalImageFile);
            }

            if (additionalImagesFiles.length === 0) {
                readProductVideos(videos, productName, productPrice, productDescription, productInfo, images);
            }
        }

        function readProductVideos(videos, productName, productPrice, productDescription, productInfo, allImages) {
            const productVideosFiles = document.getElementById('productVideos').files;
            let videoFilesProcessed = 0;

            for (let j = 0; j < productVideosFiles.length; j++) {
                const videoFile = productVideosFiles[j];
                const videoReader = new FileReader();
                videoReader.onload = function (event) {
                    videos.push(event.target.result);
                    videoFilesProcessed++;

                    if (videoFilesProcessed === productVideosFiles.length) {
                        saveProduct(allImages, videos, productName, productPrice, productDescription, productInfo);
                    }
                };
                videoReader.readAsDataURL(videoFile);
            }

            if (productVideosFiles.length === 0) {
                saveProduct(allImages, videos, productName, productPrice, productDescription, productInfo);
            }
        }

        function saveProduct(images, videos, productName, productPrice, productDescription, productInfo) {
            if (currentEditingIndex >= 0) {
                // تعديل المنتج الحالي
                products[currentEditingIndex] = {
                    name: productName,
                    price: productPrice,
                    description: productDescription,
                    info: productInfo,
                    images: images,
                    videos: videos
                };
                currentEditingIndex = -1; // إعادة تعيين المؤشر بعد التعديل
                alert('تم تعديل المنتج بنجاح!');
            } else {
                // إضافة منتج جديد
                products.push({
                    name: productName,
                    price: productPrice,
                    description: productDescription,
                    info: productInfo,
                    images: images,
                    videos: videos
                });
                alert('تم رفع المنتج بنجاح!');
            }

            localStorage.setItem('products', JSON.stringify(products));
            document.getElementById('productForm').reset();
            displayProducts();
        }

        function showProductDetails(name, price, description, info, images, videos, index) {
            document.getElementById('modalProductName').innerText = name;
            document.getElementById('modalProductPrice').innerText = 'السعر: ' + price + ' DH';
            document.getElementById('modalProductDescription').innerText = description;
            document.getElementById('modalProductInfo').innerText = 'معلومات إضافية: ' + info;

            const modalProductImage = document.getElementById('modalProductImage');
            modalProductImage.src = images[0];

            const additionalImagesContainer = document.getElementById('additionalImagesContainer');
            additionalImagesContainer.innerHTML = '';

            images.slice(1).forEach(img => {
                const imgElement = document.createElement('img');
                imgElement.src = img;
                imgElement.className = 'img-fluid mb-2';
                additionalImagesContainer.appendChild(imgElement);
            });

            const additionalVideosContainer = document.getElementById('additionalVideosContainer');
            additionalVideosContainer.innerHTML = '';

            videos.forEach(video => {
                const videoElement = document.createElement('video');
                videoElement.src = video;
                videoElement.controls = true;
                videoElement.className = 'w-100 mb-2';
                additionalVideosContainer.appendChild(videoElement);
            });

            $('#productModal').modal('show');
        }

        function displayProducts() {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';

            products.forEach((product, index) => {
                const productCard = document.createElement('div');
                productCard.className = 'card mb-3';
                productCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-text">السعر: ${product.price} DH</p>
                        <button class="btn btn-info" onclick="showProductDetails('${product.name}', '${product.price}', '${product.description}', '${product.info}', ${JSON.stringify(product.images)}, ${JSON.stringify(product.videos)}, ${index})">عرض التفاصيل</button>
                        <button class="btn btn-warning" onclick="editProduct(${index})">تعديل</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${index})">حذف</button>
                    </div>
                `;
                productList.appendChild(productCard);
            });
        }

        function editProduct(index) {
            const product = products[index];

            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productInfo').value = product.info;

            // عرض الصور والفيديوهات في النموذج (يمكن تحسين هذه الوظيفة)
            currentEditingIndex = index; // تعيين المؤشر الحالي للتعديل
            $('#productModal').modal('hide'); // إغلاق النموذج المفتوح
        }

        function deleteProduct(index) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذا المنتج؟')) {
                products.splice(index, 1);
                localStorage.setItem('products', JSON.stringify(products));
                displayProducts();
                alert('تم حذف المنتج بنجاح!');
            }
        }

        window.onload = function () {
            displayProducts();
        };
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
